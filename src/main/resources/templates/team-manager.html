<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Team Formation - <span th:text="${time.nome}"></span></title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .formation-manager {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #2196F3;
            text-decoration: none;
            font-size: 16px;
        }
        
        .team-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .manager-container {
            display: flex;
            gap: 30px;
        }
        
        .players-panel {
            width: 250px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .field-container {
            flex-grow: 1;
            position: relative;
        }
        
        .players-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .player-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
            cursor: grab;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #2196F3;
            user-select: none;
        }
        
        /* Campo de futebol com marcações de posição */
        .soccer-field {
            width: 100%;
            height: 600px;
            background: #4CAF50;
            border: 4px solid white;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            background-image: 
                linear-gradient(transparent 49%, white 49%, white 51%, transparent 51%),
                radial-gradient(circle, transparent 70px, white 70px, white 72px, transparent 72px),
                linear-gradient(90deg, white 2px, transparent 2px),
                linear-gradient(white 30%, transparent 30%),
                linear-gradient(white 30%, transparent 30%),
                linear-gradient(270deg, white 2px, transparent 2px),
                linear-gradient(white 30%, transparent 30%),
                linear-gradient(white 30%, transparent 30%),
                linear-gradient(90deg, white 2px, transparent 2px),
                linear-gradient(white 15%, transparent 15%),
                linear-gradient(white 15%, transparent 15%),
                linear-gradient(270deg, white 2px, transparent 2px),
                linear-gradient(white 15%, transparent 15%),
                linear-gradient(white 15%, transparent 15%);
            
            background-size: 
                100% 100%, 100% 100%,
                20% 40%, 20% 40%, 20% 40%,
                20% 40%, 20% 40%, 20% 40%,
                10% 20%, 10% 20%, 10% 20%,
                10% 20%, 10% 20%, 10% 20%;
            
            background-position: 
                0 0, 0 0,
                0 30%, 0 30%, 0 30%,
                100% 30%, 100% 30%, 100% 30%,
                0 40%, 0 40%, 0 40%,
                100% 40%, 100% 40%, 100% 40%;
            
            background-repeat: no-repeat;
        }
        
        /* Marcadores de posição 4-4-2 */
        .position-marker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            position: absolute;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            z-index: 1;
        }
        
        /* Jogadores no campo (sobrepostos aos marcadores) */
        .player-on-field {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            cursor: move;
            font-weight: bold;
            font-size: 16px;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            user-select: none;
            transition: transform 0.1s;
            z-index: 10;
        }
        
        .player-on-field:hover {
            transform: scale(1.1);
            z-index: 20;
        }
        
        .reset-formation {
            display: block;
            margin: 15px auto;
            padding: 8px 16px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .manager-container {
                flex-direction: column;
            }
            
            .players-panel {
                width: 100%;
            }
            
            .soccer-field {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="formation-manager">
        <a th:href="@{/times}" class="back-link">← Voltar para os Times</a>
        
        <div class="team-title">
            <h1 th:text="${time.nome}"></h1>
            <p>Arraste os jogadores para as posições do esquema 4-4-2</p>
        </div>
        
        <div class="manager-container">
            <div class="players-panel">
                <h3>Jogadores</h3>
                <button id="reset-formation" class="reset-formation">Resetar Posições</button>
                <div class="players-list" id="players-list">
                    <div th:each="jogador : ${time.jogadores}" 
                         class="player-item" 
                         draggable="true"
                         data-player-id="${jogador.id}"
                         data-player-number="${jogador.numeroCamisa}"
                         data-player-name="${jogador.nome}">
                        <span th:text="${jogador.numeroCamisa + ' - ' + jogador.nome}"></span>
                    </div>
                </div>
            </div>
            
            <div class="field-container">
                <div class="soccer-field" id="soccer-field">
                    <!-- Marcadores de posição 4-4-2 -->
                    <div class="position-marker" style="left: 48%; top: 85%;">GK</div>
                    <div class="position-marker" style="left: 18%; top: 65%;">LB</div>
                    <div class="position-marker" style="left: 33%; top: 60%;">CB</div>
                    <div class="position-marker" style="left: 63%; top: 60%;">CB</div>
                    <div class="position-marker" style="left: 78%; top: 65%;">RB</div>
                    <div class="position-marker" style="left: 23%; top: 45%;">LM</div>
                    <div class="position-marker" style="left: 38%; top: 40%;">CM</div>
                    <div class="position-marker" style="left: 58%; top: 40%;">CM</div>
                    <div class="position-marker" style="left: 73%; top: 45%;">RM</div>
                    <div class="position-marker" style="left: 38%; top: 20%;">ST</div>
                    <div class="position-marker" style="left: 58%; top: 20%;">ST</div>
                    
                    <!-- Jogadores serão posicionados aqui via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const field = document.getElementById('soccer-field');
            const playersList = document.getElementById('players-list');
            const resetButton = document.getElementById('reset-formation');
            
            let draggedPlayer = null;
            let playersOnField = [];
            
            // Coordenadas da formação 4-4-2 (em porcentagem)
            const formation442 = [
                { x: 48, y: 85, position: 'GK' },  // Goleiro
                { x: 18, y: 65, position: 'LB' },  // Lateral Esquerdo
                { x: 33, y: 60, position: 'CB' },  // Zagueiro Esquerdo
                { x: 63, y: 60, position: 'CB' },  // Zagueiro Direito
                { x: 78, y: 65, position: 'RB' },  // Lateral Direito
                { x: 23, y: 45, position: 'LM' },  // Meia Esquerda
                { x: 38, y: 40, position: 'CM' },  // Meia Central
                { x: 58, y: 40, position: 'CM' },  // Meia Central
                { x: 73, y: 45, position: 'RM' },  // Meia Direita
                { x: 38, y: 20, position: 'ST' },  // Atacante
                { x: 58, y: 20, position: 'ST' }   // Atacante
            ];
            
            // Posicionar jogadores automaticamente em 4-4-2
            function apply442Formation() {
                // Limpar jogadores existentes
                playersOnField.forEach(player => {
                    field.removeChild(player.element);
                });
                playersOnField = [];
                
                // Pegar os primeiros 11 jogadores (ou todos se menos que 11)
                const players = Array.from(playersList.querySelectorAll('.player-item'));
                const playersToPosition = players.slice(0, 11);
                
                // Posicionar cada jogador
                playersToPosition.forEach((player, index) => {
                    if (index < formation442.length) {
                        const pos = formation442[index];
                        const x = (pos.x / 100) * field.offsetWidth;
                        const y = (pos.y / 100) * field.offsetHeight;
                        
                        addPlayerToField(
                            player.dataset.playerId,
                            player.dataset.playerNumber,
                            player.dataset.playerName,
                            x, y,
                            pos.position
                        );
                    }
                });
            }
            
            // Botão para resetar formação
            resetButton.addEventListener('click', apply442Formation);
            
            // Arrastar jogadores da lista
            playersList.querySelectorAll('.player-item').forEach(player => {
                player.addEventListener('dragstart', function(e) {
                    draggedPlayer = this;
                    e.dataTransfer.setData('text/plain', this.dataset.playerId);
                    setTimeout(() => this.style.opacity = '0.4', 0);
                });
                
                player.addEventListener('dragend', function() {
                    this.style.opacity = '1';
                });
            });
            
            // Soltar jogadores no campo
            field.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            field.addEventListener('drop', function(e) {
                e.preventDefault();
                if (!draggedPlayer) return;
                
                const rect = field.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Verificar limites do campo
                const effectiveX = Math.max(25, Math.min(x, rect.width - 25));
                const effectiveY = Math.max(25, Math.min(y, rect.height - 25));
                
                // Verificar se o jogador já está no campo
                const existingPlayer = playersOnField.find(p => p.id === draggedPlayer.dataset.playerId);
                
                if (existingPlayer) {
                    // Atualizar posição
                    existingPlayer.element.style.left = `${effectiveX - 25}px`;
                    existingPlayer.element.style.top = `${effectiveY - 25}px`;
                    existingPlayer.x = effectiveX;
                    existingPlayer.y = effectiveY;
                } else {
                    // Adicionar novo jogador ao campo
                    addPlayerToField(
                        draggedPlayer.dataset.playerId,
                        draggedPlayer.dataset.playerNumber,
                        draggedPlayer.dataset.playerName,
                        effectiveX, effectiveY,
                        ''
                    );
                }
                
                draggedPlayer = null;
            });
            
            // Adicionar jogador ao campo
            function addPlayerToField(playerId, playerNumber, playerName, x, y, position) {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-on-field';
                playerElement.style.left = `${x - 25}px`;
                playerElement.style.top = `${y - 25}px`;
                playerElement.textContent = playerNumber;
                playerElement.dataset.playerId = playerId;
                playerElement.title = position ? `${playerName} (${position})` : playerName;
                playerElement.draggable = true;
                
                // Configurar arrastar para jogadores no campo
                playerElement.addEventListener('dragstart', function(e) {
                    draggedPlayer = this;
                    e.dataTransfer.setData('text/plain', this.dataset.playerId);
                    setTimeout(() => this.style.opacity = '0.7', 0);
                });
                
                playerElement.addEventListener('dragend', function() {
                    this.style.opacity = '1';
                });
                
                field.appendChild(playerElement);
                
                playersOnField.push({
                    id: playerId,
                    number: playerNumber,
                    name: playerName,
                    x: x,
                    y: y,
                    position: position,
                    element: playerElement
                });
            }
            
            // Aplicar formação 4-4-2 ao carregar a página
            apply442Formation();
        });
    </script>
</body>
</html>